<template>
  <!-- Floating Prototype Switcher -->
  <div class="floating-prototype-switcher">
    <div class={prototype1TabClass} onclick={handlePrototype1Click}>
      <span class="prototype-label">Prototype 1</span>
    </div>
    <div class={prototype2TabClass} onclick={handlePrototype2Click}>
      <span class="prototype-label">Prototype 2</span>
    </div>
    <div class={prototype3TabClass} onclick={handlePrototype3Click}>
      <span class="prototype-label">Prototype 3</span>
    </div>
  </div>

  <div class="app-container">
    <!-- Header Section -->
    <div class="slds-builder-header_container">
      <!-- Builder Header -->
      <header class="slds-builder-header">
        <!-- Back Button -->
        <div class="slds-builder-header__item">
          <div class="slds-builder-header__item-action">
            <lightning-button-icon 
              icon-name="utility:back" 
              variant="border-inverse" 
              size="small"
              alternative-text="Back">
            </lightning-button-icon>
          </div>
        </div>
        
        <!-- Lightning App Builder -->
        <div class="slds-builder-header__item">
          <div class="slds-builder-header__item-action">
            <div class="slds-media">
              <div class="slds-media__figure">
                <lightning-icon icon-name="utility:builder" size="x-small" variant="inverse"></lightning-icon>
              </div>
              <div class="slds-media__body">
                <span class="slds-truncate">Lightning App Builder</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Pages Dropdown -->
        <div class="slds-builder-header__item">
          <div class="slds-builder-header__item-action">
            <div class="slds-media">
              <div class="slds-media__figure">
                <lightning-icon icon-name="utility:page" size="x-small" variant="inverse"></lightning-icon>
              </div>
              <div class="slds-media__body">
                <span class="slds-truncate">Pages</span>
              </div>
              <div class="slds-media__figure slds-media__figure_reverse">
                <lightning-icon icon-name="utility:chevron_down" size="xx-small" variant="inverse"></lightning-icon>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Main Title (Flexible) -->
        <div class="slds-builder-header__item slds-builder-header__item_main">
          <div class="slds-builder-header__item-label">
            <span class="slds-truncate">Unified Profile for Contact</span>
          </div>
        </div>
        
        
        <!-- Help -->
        <div class="slds-builder-header__item">
          <div class="slds-builder-header__item-action">
            <div class="slds-media">
              <div class="slds-media__figure">
                <lightning-icon icon-name="utility:help" size="x-small" variant="inverse"></lightning-icon>
              </div>
              <div class="slds-media__body">
                <span class="slds-truncate">Help</span>
              </div>
            </div>
          </div>
        </div>
      </header>
      
      <!-- Builder Toolbar -->
      <div class="slds-builder-toolbar">
        <!-- Left Button Groups -->
        <div class="slds-builder-toolbar__item-group">
          <lightning-button-group>
            <lightning-button-icon 
              icon-name="utility:undo" 
              variant="border" 
              size="small"
              alternative-text="Undo">
            </lightning-button-icon>
            <lightning-button-icon 
              icon-name="utility:redo" 
              variant="border" 
              size="small"
              alternative-text="Redo">
            </lightning-button-icon>
          </lightning-button-group>
        </div>
        
        <div class="slds-builder-toolbar__item-group">
          <lightning-button-group>
            <lightning-button-icon 
              icon-name="utility:cut" 
              variant="border" 
              size="small"
              alternative-text="Cut">
            </lightning-button-icon>
            <lightning-button-icon 
              icon-name="utility:copy" 
              variant="border" 
              size="small"
              alternative-text="Copy">
            </lightning-button-icon>
            <lightning-button-icon 
              icon-name="utility:paste" 
              variant="border" 
              size="small"
              alternative-text="Paste">
            </lightning-button-icon>
          </lightning-button-group>
        </div>
        
        <!-- Middle Controls -->
        <div class="slds-builder-toolbar__item-group slds-builder-toolbar__item-group_middle">
          <lightning-combobox 
            name="desktop" 
            label="" 
            value="Desktop" 
            placeholder="Desktop"
            options={desktopOptions}
            variant="label-hidden"
            class="slds-builder-toolbar__combobox"
            onchange={handleDesktopChange}>
          </lightning-combobox>
          
          <lightning-combobox 
            name="view" 
            label="" 
            value="Shrink To View" 
            placeholder="Shrink To View"
            options={viewOptions}
            variant="label-hidden"
            class="slds-builder-toolbar__combobox slds-builder-toolbar__combobox_small"
            onchange={handleViewChange}>
          </lightning-combobox>
        </div>
        
        <!-- Right Actions -->
        <div class="slds-builder-toolbar__actions">
          <lightning-button 
            label="Analyze" 
            variant="neutral" 
            onclick={handleAnalyze}>
          </lightning-button>
          <lightning-button 
            label="Activation..." 
            variant="neutral" 
            onclick={handleActivation}>
          </lightning-button>
          <lightning-button 
            label="Save" 
            variant="brand" 
            onclick={handleSave}>
          </lightning-button>
        </div>
      </div>
    </div>

    <!-- Canvas Area -->
    <div class="canvas-container">
      <div class="canvas-content">
        <!-- Top Region -->
        <div class="drop-zone drop-zone-top">
          <div class="drop-zone-content">
            <div class="add-component-pill">
              <span class="add-component-text">Add component(s) Here</span>
            </div>
          </div>
        </div>

        <!-- Bottom Left Region with Selected Component -->
        <div class="drop-zone drop-zone-bottom-left selected-zone">
          <!-- Contact Card Component -->
          <div class="contact-card" onclick={handleCardClick}>
            <div class="contact-card-content">
              <!-- Header with Avatar and Info -->
              <div class="slds-media contact-header">
                <div class="slds-media__figure">
                  <lightning-avatar 
                    fallback-icon-name="standard:user" 
                    size="large" 
                    class="contact-avatar">
                  </lightning-avatar>
                </div>
                <div class="slds-media__body contact-info-body">
                  <h3 class="contact-name">Full Name</h3>
                  <p class="contact-location">City, State</p>
                </div>
              </div>
              
              <!-- Additional Fields from Profile Configuration - Above separator -->
              <template for:each={profileConfig.additionalFields} for:item="field">
                <div key={field.id} class="slds-media contact-detail-item additional-field-item">
                  <div class="slds-media__figure">
                    <lightning-icon 
                      icon-name={field.icon} 
                      size="x-small" 
                      class="contact-detail-icon">
                    </lightning-icon>
                  </div>
                  <div class="slds-media__body contact-detail-body">
                    <div class="contact-detail-label">{field.displayLabel}</div>
                    <div class="contact-detail-value">{field.displayLabel}</div>
                  </div>
                </div>
              </template>
              
              <!-- Separator -->
              <hr class="contact-separator">
              
              <!-- Contact Details -->
              <div class="contact-details-section">
                <!-- Region Box for Email and Phone -->
                <div class="contact-region-box">
                  <div class="slds-media contact-detail-item">
                    <div class="slds-media__figure">
                      <lightning-icon 
                        icon-name="utility:email" 
                        size="x-small" 
                        class="contact-detail-icon">
                      </lightning-icon>
                    </div>
                    <div class="slds-media__body contact-detail-body">
                      <div class="contact-detail-label">Email (3 more)</div>
                      <div class="contact-detail-value">Email@domain.com</div>
                    </div>
                  </div>
                  
                  <div class="slds-media contact-detail-item phone-field-item">
                    <div class="slds-media__figure">
                      <lightning-icon 
                        icon-name="utility:call" 
                        size="x-small" 
                        class="contact-detail-icon">
                      </lightning-icon>
                    </div>
                    <div class="slds-media__body contact-detail-body">
                      <div class="contact-detail-label">Phone (2 more)</div>
                      <div class="contact-detail-value">1234567890</div>
                    </div>
                  </div>
                  
                  <!-- Additional Contact Fields (controlled by Section 1 field count) -->
                  <template for:each={contactConfig.additionalFields} for:item="field">
                    <div key={field.id} class="slds-media contact-detail-item additional-contact-field-item">
                      <div class="slds-media__figure">
                        <lightning-icon 
                          icon-name={field.icon} 
                          size="x-small" 
                          class="contact-detail-icon">
                        </lightning-icon>
                      </div>
                      <div class="slds-media__body contact-detail-body">
                        <div class="contact-detail-label">{field.displayLabel}</div>
                        <div class="contact-detail-value">{field.displayLabel}</div>
                      </div>
                    </div>
                  </template>
                </div>
                
                <!-- Additional Sections (Added via "Add Section") -->
                <template for:each={profileConfig.additionalSections} for:item="section">
                  <div key={section.id}>
                    <!-- Section Divider (separate div, same as contact-separator) -->
                    <div>
                      <hr class="contact-separator">
                    </div>
                    
                    <!-- New Section with Region Box (like Contact section) -->
                    <div class="new-section-region-box">
                      <template for:each={section.fields} for:item="field">
                        <div key={field.id} 
                             class="slds-media contact-detail-item field-configurable" 
                             onclick={handleFieldClick}
                             onmouseenter={handleFieldHover}
                             onmouseleave={handleFieldHoverOut}
                             data-field-id={field.id}
                             data-section-id={section.id}>
                          <div class="slds-media__figure">
                            <template if:true={field.icon}>
                              <lightning-icon 
                                icon-name={field.icon}
                                size="x-small"
                                class="contact-detail-icon">
                              </lightning-icon>
                            </template>
                            <template if:false={field.icon}>
                              <div class="contact-detail-icon-placeholder"></div>
                            </template>
                          </div>
                          <div class="slds-media__body contact-detail-body">
                            <div class="contact-detail-label">{field.label}</div>
                            <div class="contact-detail-value">{field.value}</div>
                          </div>
                        </div>
                      </template>
                    </div>
                  </div>
                </template>
                
                <!-- Insight Fields Section -->
                <template if:true={hasInsightFields}>
                  <!-- Insight Separator -->
                  <hr class="insight-separator">
                  
                  <!-- Insight Fields -->
                  <template for:each={insightsConfig.additionalFields} for:item="field">
                    <div key={field.id} class="slds-media contact-detail-item insight-field-item">
                      <div class="slds-media__figure">
                        <lightning-icon 
                          icon-name={field.icon} 
                          size="x-small" 
                          class="contact-detail-icon">
                        </lightning-icon>
                      </div>
                      <div class="slds-media__body contact-detail-body">
                        <div class="contact-detail-label">{field.displayLabel}</div>
                        <div class="contact-detail-value">{field.displayLabel}</div>
                      </div>
                    </div>
                  </template>
                </template>
              </div>
            </div>
          </div>
          
          <!-- Selection Border and Handles (hidden when field is selected) -->
          <div class={selectionBorderClass}></div>
          <div class={resizeHandleTopClass}>
            <div class="resize-handle-icon">+</div>
          </div>
          <div class={resizeHandleBottomClass}>
            <div class="resize-handle-icon">+</div>
          </div>
        </div>

        <!-- Bottom Right Region -->
        <div class="drop-zone drop-zone-bottom-right">
          <div class="drop-zone-content">
            <div class="add-component-pill">
              <span class="add-component-text">Add component(s) Here</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Component Panel -->
    <div class="component-panel">
      <!-- Tabs -->
      <div class="panel-tabs">
        <lightning-tabset active-tab-value="components">
          <lightning-tab label="Components" value="components"></lightning-tab>
          <lightning-tab label="Fields" value="fields"></lightning-tab>
        </lightning-tabset>
      </div>
      
      <!-- Search -->
      <div class="panel-search">
        <lightning-input 
          type="search" 
          label="Search"
          placeholder="Search..." 
          class="search-input"
          variant="label-hidden"
          onchange={handleSearch}>
        </lightning-input>
        <lightning-button-icon 
          icon-name="utility:settings" 
          variant="border" 
          class="settings-button">
        </lightning-button-icon>
      </div>
      
      <!-- Accordion -->
      <div class="panel-accordion">
        <lightning-accordion>
          <lightning-accordion-section name="standard" label="Standard (67)">
            <!-- Component List -->
            <div class="component-list">
              <template for:each={componentItems} for:item="item">
                <div key={item.id} class="list-item">
                  <div class="item-icon">
                    <template if:false={item.customSvg}>
                      <lightning-icon 
                        icon-name={item.icon} 
                        size="small">
                      </lightning-icon>
                    </template>
                    <template if:true={item.customSvg}>
                      <img src={item.customSvg} alt={item.label} class="custom-svg-icon">
                    </template>
                  </div>
                  <span class="item-label">{item.label}</span>
                </div>
              </template>
            </div>
          </lightning-accordion-section>
        </lightning-accordion>
      </div>
      
      <!-- AppExchange Footer -->
      <div class="appexchange-footer">
        <span class="footer-text">Get more on the AppExchange</span>
      </div>
    </div>
    
    <!-- Right Properties Panel -->
    <div class="properties-panel">
      
      <!-- Field Configuration Panel (shown when field is selected) -->
      <template if:true={isFieldConfigMode}>
        <div class="field-config-panel">
          <!-- Header with Breadcrumb -->
          <div class="field-config-header">
            <div class="breadcrumb-container">
              <span class="breadcrumb-link">Page</span>
              <span class="breadcrumb-separator">></span>
              <span class="breadcrumb-current">Field</span>
            </div>
          </div>
          
          <!-- Body Content -->
          <div class="field-config-body">
            <!-- Descriptive Text -->
            <div class="field-config-description">
              <p class="description-text">
                Select a field from the objects in the Data Cloud Unified Profile Builder or Data Cloud Copy Fields to display in the component. 
                <a href="#" class="learn-more-link">Learn More</a>
              </p>
            </div>
            
            <!-- Form Fields -->
            <div class="slds-form field-config-form">
              <!-- Object Name -->
              <lightning-combobox
                label="Object Name"
                name="configObjectName"
                value={configObjectName}
                placeholder="Select an object"
                options={objectNameOptions}
                onchange={handleObjectNameConfigChange}
                class="popover-field">
              </lightning-combobox>

              <!-- Metric Name / Field Name -->
              <lightning-combobox
                label={fieldNameLabel}
                name="configFieldName"
                value={configFieldName}
                placeholder={fieldNamePlaceholder}
                options={fieldNameOptionsToUse}
                onchange={handleFieldNameConfigChange}
                class="popover-field">
              </lightning-combobox>

              <!-- Display Label -->
              <lightning-input
                label="Display Label"
                name="configDisplayLabel"
                value={configDisplayLabel}
                onchange={handleDisplayLabelConfigChange}
                class="popover-field">
              </lightning-input>

              <!-- Icon -->
              <lightning-combobox
                label="Icon"
                name="configIcon"
                value={configIcon}
                placeholder="Select an icon"
                options={currentIconOptions}
                onchange={handleIconConfigChange}
                class="popover-field">
              </lightning-combobox>

              <!-- Set Field Visibility Accordion -->
              <lightning-accordion allow-multiple-sections-open class="field-visibility-accordion">
                <lightning-accordion-section name="fieldVisibility" label="Set Field Visibility">
                  <div class="visibility-content">
                    <div class="filter-section">
                      <label>Filter</label>
                      <lightning-button
                        label="Add Filter"
                        icon-name="utility:add"
                        variant="neutral"
                        class="add-filter-button">
                      </lightning-button>
                    </div>
                  </div>
                </lightning-accordion-section>
              </lightning-accordion>
            </div>
          </div>
        </div>
      </template>

      <!-- Section Management Panel (shown when no field is selected) -->
      <template if:false={isFieldConfigMode}>
          <!-- Header with Breadcrumb -->
          <div class="properties-header">
              <div class="breadcrumb-container">
                <span class="breadcrumb-link">Page</span>
                <span class="breadcrumb-separator"> > </span>
                <span class="breadcrumb-current">Data Cloud Unified Profile</span>
              </div>
          </div>
          
          <!-- Body Content -->
          <div class="properties-body">
            <!-- Description Text -->
            <div class="properties-description">
              <p>This component displays unified profile data from Data Cloud. To use it, you must first set up the Data Cloud Related Lists in the Object Manager. 
                <a href="#" class="slds-text-link">Learn More</a>
              </p>
            </div>
            
              <!-- Instruction Text -->
              <div class="instruction-text slds-text-body_regular" style="color: #3e3e3c;">
                Select the Data Space and Unified Object to find your Data Cloud Related Lists.
              </div>
              
              <!-- Data Cloud Builder Selection -->
              <div class="properties-field" style="margin-bottom: 0;">
                <lightning-combobox
                  name="dataCloudBuilder"
                  label="Data Space"
                  placeholder="Select a Data Space"
                  options={dataSpaceOptions}
                  value="default"
                  required
                  class="data-cloud-combobox">
                </lightning-combobox>
              </div>

              <!-- Unified Object Selection -->
              <div class="properties-field">
                <lightning-combobox
                  name="unifiedObject"
                  label="Unified Object"
                  placeholder="Select a Unified Object"
                  options={unifiedObjectOptions}
                  value="unified-individual"
                  required
                  class="unified-object-combobox">
                </lightning-combobox>
              </div>
          
          <!-- Properties Accordion -->
          <lightning-accordion 
            allow-multiple-sections-open 
            active-section-name={activeAccordionSection}
            onsectiontoggle={handleAccordionToggle}>
            <!-- Customize Sections -->
            <lightning-accordion-section name="customizeSections" label="Manage Sections" onsectiontoggle={handleCustomizeSectionToggle} is-open>
            <div class="section-items">
          <!-- Scoped Notification -->
          <div class="slds-scoped-notification slds-media slds-scoped-notification_light" role="status">
            <div class="slds-media__figure">
              <lightning-icon 
                icon-name="utility:info" 
                size="small" 
                class="slds-icon_small">
              </lightning-icon>
            </div>
            <div class="slds-media__body">
              <p>
                Field visibility in each section depends on user permissions defined by policies. 
                The preview displays placeholder data only. 
                <a href="#" class="slds-text-link">Learn More</a>
              </p>
            </div>
          </div>
              
              <!-- Profile Section Configuration (from Prototype 2) -->
              <div class="profile-section-content">
                <!-- Basic Profile Fields -->
                <div class="slds-form-element basic-profile-fields-section">
                  <fieldset class="slds-form-element">
                    <legend class="slds-form-element__legend slds-form-element__label profile-field-label">Basic Profile Fields</legend>
                    <div class="slds-form-element__control">
                      <lightning-checkbox-group 
                        name="basicProfileFields"
                        label=""
                        options={basicProfileFieldOptions}
                        value={selectedBasicFields}
                        variant="label-hidden">
                      </lightning-checkbox-group>
                    </div>
                  </fieldset>
                </div>
                
                <!-- Additional Sections -->
                <div class="slds-form-element additional-fields-section">
                  <div class="slds-form-element__label-container">
                    <div class="additional-fields-label-row">
                      <label class="slds-form-element__label profile-field-label">Additional Sections</label>
                    </div>
                  </div>
                  
                  <!-- Section Pills -->
                  <div class="additional-fields-container additional-fields-pills-section">
                    <template for:each={additionalProfileFields} for:item="field">
                      <div key={field.id} class="section-pill-container">
                        <div class="section-pill" data-visible={field.isVisible}>
                          <!-- First Row: Drag Handle, Section Name, and Dropdown Button -->
                          <div class="section-header-row">
                            <lightning-icon 
                              icon-name="utility:drag_and_drop" 
                              size="x-small" 
                              class="section-drag-handle">
                            </lightning-icon>
                            
                            <span class="section-name">{field.displayName}</span>
                            
                            <lightning-button-menu 
                              alternative-text="Section options"
                              icon-size="x-small"
                              menu-alignment="right"
                              variant="border-filled"
                              onselect={handleSectionMenuSelect}
                              data-field-id={field.id}
                              class="section-dropdown-button">
                              <lightning-menu-item 
                                value="invisible" 
                                label={field.visibilityMenuLabel}>
                              </lightning-menu-item>
                              <lightning-menu-item 
                                value="delete" 
                                label="Delete">
                              </lightning-menu-item>
                            </lightning-button-menu>
                          </div>
                          
                          <!-- Second Row: Field Counter Input -->
                          <lightning-input
                            type="number"
                            label="Number of Fields"
                            value={field.fieldCount}
                            min="1"
                            max="5"
                            step="1"
                            onchange={handleFieldCountChange}
                            onblur={handleFieldCountBlur}
                            data-field-id={field.id}
                            class="field-counter-input"
                            message-when-range-overflow="The number should within 1 to 5"
                            message-when-range-underflow="The number should within 1 to 5"
                            message-when-bad-input="The number should within 1 to 5">
                          </lightning-input>
                        </div>
                      </div>
                    </template>
                    
                    <!-- Add Section Button -->
                    <button class="slds-button slds-button_neutral add-field-button slds-m-top_x-small" type="button" onclick={handleAddProfileField} disabled={isAddFieldButtonDisabled}>
                      <svg class="slds-button__icon slds-button__icon_left" aria-hidden="true" viewBox="0 0 520 520">
                        <path d="M300 290h165c8 0 15-7 15-15v-30c0-8-7-15-15-15H300c-6 0-10-4-10-10V55c0-8-7-15-15-15h-30c-8 0-15 7-15 15v165c0 6-4 10-10 10H55c-8 0-15 7-15 15v30c0 8 7 15 15 15h165c6 0 10 4 10 10v165c0 8 7 15 15 15h30c8 0 15-7 15-15V300c0-6 4-10 10-10z"/>
                      </svg>
                      Add Section
                    </button>
                    
                  </div>
                </div>
              </div>
              
              <!-- Insights Section -->
              <template if:true={showInsightsSection}>
                <div class="section-item">
                  <div class="section-item-content">
                    <lightning-icon 
                      icon-name="utility:drag_and_drop" 
                      size="x-small" 
                      class="drag-icon">
                    </lightning-icon>
                    <span class="section-item-label insights-name-clickable" onclick={handleInsightsNameClick}>Insights</span>
                  </div>
                  <div class="section-dropdown-container">
                    <button class="slds-button slds-button_icon slds-button_icon-border slds-button_icon-small section-dropdown-button" onclick={handleInsightsMenu}>
                      <lightning-icon icon-name="utility:down" size="x-small" alternative-text="More actions"></lightning-icon>
                      <span class="slds-assistive-text">More actions</span>
                    </button>
                    <div class="slds-dropdown slds-dropdown_right section-menu" if:true={showInsightsMenu}>
                      <ul class="slds-dropdown__list" role="menu">
                        <li class="slds-dropdown__item" role="presentation">
                          <a href="#" role="menuitem" onclick={handleInsightsEdit}>
                            <span class="slds-truncate">Edit</span>
                          </a>
                        </li>
                        <li class="slds-dropdown__item" role="presentation">
                          <a href="#" role="menuitem" onclick={handleInsightsSetInvisible}>
                            <span class="slds-truncate">Set As Invisible</span>
                          </a>
                        </li>
                        <li class="slds-dropdown__item" role="presentation">
                          <a href="#" role="menuitem" onclick={handleInsightsDelete}>
                            <span class="slds-truncate">Delete</span>
                          </a>
                        </li>
                      </ul>
                    </div>
                  </div>
                </div>
              </template>
              
              <!-- Add Section button removed for Prototype 3 -->
            </div>
          </lightning-accordion-section>
          
          <!-- Set Theme Details -->
          <lightning-accordion-section name="themeDetails" label="Set Theme Details">
            <div class="theme-content">
             <!-- Background Color Picker -->
             <div class="color-picker-field">
               <label>Background Color</label>
               <div class="color-picker-container">
                 <div class="color-picker-swatch">
                   <div class="color-swatch" style="background-color: #1591C3;"></div>
                   <lightning-icon icon-name="utility:down" size="x-small"></lightning-icon>
                 </div>
                 <lightning-input
                   type="text"
                   label="Color"
                   value="#1591C3"
                   variant="label-hidden"
                   class="color-input">
                 </lightning-input>
               </div>
             </div>
            </div>
          </lightning-accordion-section>
          
          <!-- Set Component Visibility Accordion -->
          <lightning-accordion-section name="componentVisibility" label="Set Component Visibility">
            <div class="visibility-content">
              <div class="filter-section">
                <label>Filter</label>
                <lightning-button
                  label="Add Filter"
                  icon-name="utility:add"
                  variant="neutral"
                  class="add-filter-button">
                </lightning-button>
              </div>
            </div>
          </lightning-accordion-section>
        </lightning-accordion>
          </div> <!-- End properties-body -->
        </template>
      </div> <!-- End properties-panel -->
  </div>

  <!-- Note: All modal components removed for Prototype 3 -->
  <!-- Prototype 3 will use inline editing instead of modals -->
</template>
